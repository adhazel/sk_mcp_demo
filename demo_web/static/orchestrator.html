<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Orchestrator Web Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }
        
        .architecture {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .status.healthy {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.unhealthy {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chat-section {
            margin-bottom: 30px;
        }
        
        .chat-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #fafafa;
            margin-bottom: 15px;
        }
        
        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            line-height: 1.4;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word;
        }
        
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: 20%;
        }
        
        .assistant-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Courier New', monospace;
        }
        
        .orchestrator-info {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .send-button {
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .send-button:hover {
            background-color: #0056b3;
        }
        
        .send-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .tools-section {
            margin-top: 30px;
        }
        
        .tools-panel-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
            height: 600px;
        }
        
        .tools-panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            text-align: center;
        }
        
        .panel-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .tool-list-item {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .tool-list-item:hover {
            background-color: #e7f3ff;
        }
        
        .tool-list-item.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .tool-list-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .tool-list-description {
            font-size: 12px;
            color: #666;
        }
        
        .tool-list-item.selected .tool-list-description {
            color: #cce7ff;
        }
        
        .parameter-form {
            display: none;
        }
        
        .parameter-form.active {
            display: block;
        }
        
        .parameter-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #0066cc;
        }
        
        .parameter-field {
            margin-bottom: 15px;
        }
        
        .parameter-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .parameter-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .parameter-description {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .submit-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
        }
        
        .submit-button:hover {
            background-color: #218838;
        }
        
        .submit-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .tool-output {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-y: auto;
            flex: 1;
            min-height: 200px;
        }
        
        .tool-output-header {
            font-weight: bold;
            color: #007bff;
            font-family: Arial, sans-serif;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .no-selection {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 50px 20px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† MCP Orchestrator Web Demo</h1>
        <p class="subtitle">Advanced MCP integration using Semantic Kernel Agents</p>
        
        <div class="architecture">
            ProductChatAgent ‚Üí ChatCompletionAgent ‚Üí MCPStreamableHttpPlugin ‚Üí MCP Server
        </div>
        
        <div id="status" class="status">
            <span id="status-text">Checking connection...</span>
        </div>
        
        <div class="chat-section">
            <h3>üí¨ Intelligent Chat Interface</h3>
            <p>Ask questions and the orchestrator will automatically select and coordinate the appropriate MCP tools.</p>
            
            <div id="chat-container" class="chat-container">
                <div class="message assistant-message">
                    <strong>ü§ñ MCP Orchestrator:</strong> Hello! I'm powered by Semantic Kernel Agents with intelligent MCP tool orchestration. Ask me anything about products, or request complex research that combines internal knowledge with web search.
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask me anything... (e.g., 'I need a laptop for gaming' or 'evaluate the quality of this answer')" onkeypress="handleChatKeyPress(event)">
                <button id="send-button" class="send-button" onclick="sendChatMessage()">Send</button>
            </div>
        </div>
        
        <div class="tools-section">
            <h3>üîß MCP Tools Testing Interface</h3>
            <p>Select a tool to test, configure parameters, and view results.</p>
            <div class="tools-panel-layout">
                <!-- Left Panel: Tool List -->
                <div class="tools-panel">
                    <div class="panel-header">Available Tools</div>
                    <div class="panel-content">
                        <div id="tool-list">
                            <div class="tool-list-item">
                                <div class="tool-list-name">Loading tools...</div>
                                <div class="tool-list-description">Discovering available MCP tools...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Panel: Parameters -->
                <div class="tools-panel">
                    <div class="panel-header">Parameters</div>
                    <div class="panel-content">
                        <div id="parameter-panel">
                            <div class="no-selection">Select a tool to configure parameters</div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel: Results -->
                <div class="tools-panel">
                    <div class="panel-header">Results</div>
                    <div class="panel-content">
                        <div id="results-panel">
                            <div class="no-selection">Tool results will appear here</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;
        let selectedTool = null;
        let availableTools = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            checkHealth();
            loadTools();
        });

        async function checkHealth() {
            console.log('Checking health...');
            try {
                const response = await fetch('/health');
                const health = await response.json();
                console.log('Health response:', health);
                
                const statusElement = document.getElementById('status');
                const statusText = document.getElementById('status-text');
                
                if (health.status === 'healthy') {
                    statusElement.className = 'status healthy';
                    statusText.textContent = `‚úÖ Connected to MCP Server (${health.mcp_server_health})`;
                } else {
                    statusElement.className = 'status unhealthy';
                    statusText.textContent = `‚ùå Connection failed: ${health.error || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Health check error:', error);
                const statusElement = document.getElementById('status');
                const statusText = document.getElementById('status-text');
                statusElement.className = 'status unhealthy';
                statusText.textContent = `‚ùå Cannot connect to server: ${error.message}`;
            }
        }

        async function loadTools() {
            console.log('Loading tools...');
            try {
                const response = await fetch('/tools');
                const data = await response.json();
                console.log('Tools response:', data);
                
                const toolList = document.getElementById('tool-list');
                toolList.innerHTML = '';
                
                if (data.tools && data.tools.length > 0) {
                    availableTools = data.tools;
                    data.tools.forEach(tool => {
                        const toolItem = document.createElement('div');
                        toolItem.className = 'tool-list-item';
                        toolItem.onclick = () => selectTool(tool);
                        toolItem.innerHTML = `
                            <div class="tool-list-name">${tool.name}</div>
                            <div class="tool-list-description">${tool.description || 'No description available'}</div>
                        `;
                        toolList.appendChild(toolItem);
                    });
                } else {
                    toolList.innerHTML = '<div class="no-selection">No tools available</div>';
                }
            } catch (error) {
                console.error('Load tools error:', error);
                const toolList = document.getElementById('tool-list');
                toolList.innerHTML = `<div class="no-selection">Error loading tools: ${error.message}</div>`;
            }
        }

        function selectTool(tool) {
            console.log('Selecting tool:', tool);
            selectedTool = tool;
            
            // Update selected tool in left panel
            document.querySelectorAll('.tool-list-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Generate parameter form in middle panel
            generateParameterForm(tool);
            
            // Clear results panel
            const resultsPanel = document.getElementById('results-panel');
            resultsPanel.innerHTML = '<div class="no-selection">Configure parameters and click Submit to see results</div>';
        }

        function generateParameterForm(tool) {
            const parameterPanel = document.getElementById('parameter-panel');
            
            let formHTML = `<form id="tool-form" onsubmit="submitTool(event)">`;
            let hasParameters = false;
            
            // Try to find parameters in the schema
            let properties = null;
            let required = [];
            
            if (tool.schema && tool.schema.inputSchema && tool.schema.inputSchema.properties) {
                properties = tool.schema.inputSchema.properties;
                required = tool.schema.inputSchema.required || [];
                hasParameters = true;
            }
            
            if (hasParameters) {
                formHTML += `<div class="parameter-info">Parameters for <strong>${tool.name}</strong>:</div>`;
                
                Object.keys(properties).forEach(paramName => {
                    const param = properties[paramName];
                    const isRequired = required.includes(paramName);
                    
                    // Get default value if available
                    const defaultValue = param.default !== undefined ? param.default : '';
                    
                    // Determine input type based on parameter type
                    let inputType = 'text';
                    let inputElement = 'input';
                    let additionalAttrs = '';
                    
                    if (param.type === 'number' || param.type === 'integer') {
                        inputType = 'number';
                    } else if (param.type === 'boolean') {
                        inputElement = 'select';
                        additionalAttrs = `
                            <option value="">Select...</option>
                            <option value="true" ${defaultValue === true ? 'selected' : ''}>true</option>
                            <option value="false" ${defaultValue === false ? 'selected' : ''}>false</option>
                        `;
                    } else if (param.type === 'array') {
                        inputElement = 'textarea';
                        additionalAttrs = 'rows="3"';
                    }
                    
                    let placeholder = param.description || `Enter ${paramName}`;
                    if (param.type === 'array') {
                        placeholder = 'Enter comma-separated values or JSON array';
                    }
                    
                    formHTML += `
                        <div class="parameter-field">
                            <label class="parameter-label" for="${paramName}">
                                ${paramName}${isRequired ? ' *' : ''}
                                ${param.type ? ` (${param.type})` : ''}
                            </label>`;
                    
                    if (inputElement === 'input') {
                        formHTML += `
                            <input 
                                type="${inputType}" 
                                id="${paramName}" 
                                name="${paramName}" 
                                class="parameter-input"
                                ${isRequired ? 'required' : ''}
                                placeholder="${placeholder}"
                                value="${defaultValue}"
                            />`;
                    } else if (inputElement === 'select') {
                        formHTML += `
                            <select 
                                id="${paramName}" 
                                name="${paramName}" 
                                class="parameter-input"
                                ${isRequired ? 'required' : ''}
                            >
                                ${additionalAttrs}
                            </select>`;
                    } else if (inputElement === 'textarea') {
                        const textValue = Array.isArray(defaultValue) ? JSON.stringify(defaultValue) : defaultValue;
                        formHTML += `
                            <textarea 
                                id="${paramName}" 
                                name="${paramName}" 
                                class="parameter-input"
                                ${isRequired ? 'required' : ''}
                                placeholder="${placeholder}"
                                ${additionalAttrs}
                            >${textValue}</textarea>`;
                    }
                    
                    formHTML += `
                            ${param.description ? `<div class="parameter-description">${param.description}</div>` : ''}
                        </div>
                    `;
                });
            } else {
                formHTML += `
                    <div class="parameter-info">No structured parameters detected for <strong>${tool.name}</strong></div>
                    <div class="parameter-field">
                        <label class="parameter-label" for="json-params">Parameters (JSON)</label>
                        <textarea 
                            id="json-params" 
                            name="json-params" 
                            class="parameter-input"
                            rows="8"
                            placeholder='{"param1": "value1", "param2": "value2"}'
                        ></textarea>
                    </div>
                `;
            }
            
            formHTML += `<button type="submit" class="submit-button">Submit Tool Test</button></form>`;
            parameterPanel.innerHTML = formHTML;
        }

        async function submitTool(event) {
            event.preventDefault();
            
            if (!selectedTool) return;
            
            const form = document.getElementById('tool-form');
            const formData = new FormData(form);
            let parameters = {};
            
            // Check if using JSON input or individual fields
            const jsonParams = formData.get('json-params');
            if (jsonParams) {
                try {
                    parameters = JSON.parse(jsonParams);
                } catch (e) {
                    showError('Invalid JSON format in parameters');
                    return;
                }
            } else {
                // Collect individual form fields
                for (let [key, value] of formData.entries()) {
                    if (value.trim()) {
                        parameters[key] = value;
                    }
                }
            }
            
            // Disable submit button during request
            const submitButton = form.querySelector('.submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Running...';
            
            try {
                const response = await fetch('/call-tool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool_name: selectedTool.name,
                        parameters: parameters
                    })
                });
                
                const result = await response.json();
                showResults(selectedTool.name, parameters, result);
                
            } catch (error) {
                showError(`Error calling tool: ${error.message}`);
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Tool Test';
            }
        }
        
        function showResults(toolName, parameters, result) {
            const resultsPanel = document.getElementById('results-panel');
            const timestamp = new Date().toLocaleTimeString();
            
            const resultHTML = `
                <div class="tool-output">
                    <div class="tool-output-header">üîß ${toolName} - ${timestamp}</div>
                    <div><strong>Parameters:</strong></div>
                    <div>${JSON.stringify(parameters, null, 2)}</div>
                    <div style="margin-top: 15px;"><strong>Result:</strong></div>
                    <div>${JSON.stringify(result, null, 2)}</div>
                </div>
            `;
            
            resultsPanel.innerHTML = resultHTML;
        }

        function showError(message) {
            const resultsPanel = document.getElementById('results-panel');
            const timestamp = new Date().toLocaleTimeString();
            
            const errorHTML = `
                <div class="tool-output" style="border-color: #dc3545; background-color: #f8d7da;">
                    <div class="tool-output-header" style="color: #dc3545;">‚ùå Error - ${timestamp}</div>
                    <div>${message}</div>
                </div>
            `;
            
            resultsPanel.innerHTML = errorHTML;
        }

        async function sendChatMessage() {
            if (isLoading) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input and show loading state
            input.value = '';
            isLoading = true;
            document.getElementById('send-button').disabled = true;
            document.getElementById('send-button').textContent = 'Thinking...';
            
            // Add user message to chat
            addMessage(message, 'user');
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                        // Removed use_evaluation - let Semantic Kernel decide intelligently!
                    })
                });
                
                const result = await response.json();
                console.log('Chat result:', result);
                
                if (result.success) {
                    let assistantMessage = '';
                    
                    // Extract the actual response content, not the JSON structure
                    if (result.tool_result && result.tool_result.response) {
                        assistantMessage = result.tool_result.response;
                    } else if (result.tool_result && typeof result.tool_result === 'string') {
                        assistantMessage = result.tool_result;
                    } else if (result.response) {
                        assistantMessage = result.response;
                    } else if (result.message) {
                        assistantMessage = result.message;
                    } else {
                        // Fallback to JSON if we can't find a clean text response
                        assistantMessage = JSON.stringify(result.tool_result, null, 2);
                    }
                    
                    addMessage(assistantMessage, 'assistant');
                } else {
                    addMessage(`Error: ${result.error}`, 'assistant', { error: true });
                }
                
            } catch (error) {
                addMessage(`Network error: ${error.message}`, 'assistant', { error: true });
            } finally {
                isLoading = false;
                document.getElementById('send-button').disabled = false;
                document.getElementById('send-button').textContent = 'Send';
            }
        }

        function addMessage(text, sender, metadata = {}) {
            const chatContainer = document.getElementById('chat-container');
            const message = document.createElement('div');
            message.className = `message ${sender}-message`;
            
            const senderLabel = sender === 'user' ? 'üë§ You' : 'ü§ñ MCP Orchestrator';
            
            // Ensure text is a string before formatting
            const textString = typeof text === 'string' ? text : JSON.stringify(text, null, 2);
            
            // Convert newlines to HTML line breaks and preserve formatting
            const formattedText = textString
                .replace(/\n/g, '<br>')
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
                .replace(/  /g, '&nbsp;&nbsp;'); // Preserve multiple spaces
            
            let messageContent = `<strong>${senderLabel}:</strong> ${formattedText}`;
            
            if (metadata.orchestrator && !metadata.error) {
                messageContent += `<div class="orchestrator-info">
                    <strong>Orchestrator:</strong> ${metadata.orchestrator}`;
                
                if (metadata.evaluation) {
                    messageContent += `<br><strong>Evaluation:</strong> ${metadata.evaluation}`;
                }
                
                messageContent += '</div>';
            }
            
            message.innerHTML = messageContent;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Refresh health status every 30 seconds
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
